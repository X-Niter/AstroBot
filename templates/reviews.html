{% extends 'base.html' %}

{% block extra_head %}
<style>
    .review-card {
        border-radius: 10px;
        border: 1px solid #2a2a2a;
        background-color: #1a1a1a;
        margin-bottom: 20px;
        transition: transform 0.3s ease;
    }
    .review-card:hover {
        transform: translateY(-5px);
    }
    .review-header {
        padding: 15px;
        border-bottom: 1px solid #2a2a2a;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .review-body {
        padding: 15px;
    }
    .review-footer {
        padding: 10px 15px;
        border-top: 1px solid #2a2a2a;
        font-size: 0.85rem;
        color: #6c757d;
    }
    .star-filled {
        color: gold;
    }
    .star-empty {
        color: #666;
    }
    .filter-box {
        padding: 15px;
        border-radius: 10px;
        border: 1px solid #2a2a2a;
        background-color: #1a1a1a;
        margin-bottom: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h2><i class="fas fa-star me-2"></i>Minecraft Mod Reviews</h2>
        <p class="text-muted">Community reviews and ratings for Minecraft mods</p>
    </div>
</div>

<div class="row mb-4">
    <div class="col-md-4 mb-3">
        <div class="filter-box">
            <h5>Search & Filter</h5>
            <div class="mb-3">
                <label for="mod-search" class="form-label">Mod Name</label>
                <input type="text" class="form-control bg-dark text-light border-secondary" id="mod-search" placeholder="Search mods...">
            </div>
            <div class="mb-3">
                <label for="rating-filter" class="form-label">Minimum Rating</label>
                <select class="form-select bg-dark text-light border-secondary" id="rating-filter">
                    <option value="0">All Ratings</option>
                    <option value="1">★ or higher</option>
                    <option value="2">★★ or higher</option>
                    <option value="3">★★★ or higher</option>
                    <option value="4">★★★★ or higher</option>
                    <option value="5">★★★★★ only</option>
                </select>
            </div>
            <button type="button" class="btn btn-primary" onclick="filterReviews()">
                <i class="fas fa-filter me-2"></i>Apply Filters
            </button>
        </div>
        
        <div class="card bg-dark border-secondary">
            <div class="card-header bg-primary text-white">
                <h5 class="m-0">Top Rated Mods</h5>
            </div>
            <ul class="list-group list-group-flush" id="top-mods">
                <li class="list-group-item bg-dark text-light border-secondary">Loading top mods...</li>
            </ul>
        </div>
    </div>
    
    <div class="col-md-8">
        <div id="reviews-container">
            <div class="text-center p-5">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading reviews...</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Format stars based on rating
    function formatStars(rating) {
        let stars = '';
        for (let i = 1; i <= 5; i++) {
            if (i <= rating) {
                stars += '<i class="fas fa-star star-filled"></i> ';
            } else {
                stars += '<i class="far fa-star star-empty"></i> ';
            }
        }
        return stars;
    }
    
    // Format date
    function formatDate(dateString) {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }
    
    // Fetch reviews from the API
    async function fetchReviews() {
        try {
            const response = await fetch('/api/reviews');
            if (!response.ok) {
                throw new Error('Failed to fetch reviews');
            }
            const reviews = await response.json();
            
            // Group reviews by mod
            const modReviews = {};
            reviews.forEach(review => {
                if (!modReviews[review.mod_name]) {
                    modReviews[review.mod_name] = {
                        reviews: [],
                        avgRating: 0,
                        totalRating: 0
                    };
                }
                modReviews[review.mod_name].reviews.push(review);
                modReviews[review.mod_name].totalRating += review.rating;
            });
            
            // Calculate average rating for each mod
            Object.keys(modReviews).forEach(mod => {
                modReviews[mod].avgRating = modReviews[mod].totalRating / modReviews[mod].reviews.length;
            });
            
            // Sort mods by average rating
            const sortedMods = Object.keys(modReviews).sort((a, b) => 
                modReviews[b].avgRating - modReviews[a].avgRating);
            
            // Update top mods list
            const topModsList = document.getElementById('top-mods');
            topModsList.innerHTML = '';
            
            if (sortedMods.length > 0) {
                sortedMods.slice(0, 5).forEach(mod => {
                    const avgRating = modReviews[mod].avgRating;
                    const listItem = document.createElement('li');
                    listItem.className = 'list-group-item bg-dark text-light border-secondary';
                    listItem.innerHTML = `
                        <div class="d-flex justify-content-between align-items-center">
                            <span>${mod}</span>
                            <div>${formatStars(Math.round(avgRating))}</div>
                        </div>
                        <small class="text-muted">${modReviews[mod].reviews.length} reviews</small>
                    `;
                    topModsList.appendChild(listItem);
                });
            } else {
                const listItem = document.createElement('li');
                listItem.className = 'list-group-item bg-dark text-light border-secondary';
                listItem.textContent = 'No reviews found';
                topModsList.appendChild(listItem);
            }
            
            // Update reviews container
            const reviewsContainer = document.getElementById('reviews-container');
            reviewsContainer.innerHTML = '';
            
            if (reviews.length > 0) {
                reviews.forEach(review => {
                    const reviewCard = document.createElement('div');
                    reviewCard.className = 'review-card';
                    reviewCard.setAttribute('data-mod', review.mod_name.toLowerCase());
                    reviewCard.setAttribute('data-rating', review.rating);
                    
                    reviewCard.innerHTML = `
                        <div class="review-header">
                            <div>
                                <h5>${review.mod_name}</h5>
                                <div>${formatStars(review.rating)}</div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-primary">By ${review.discord_name}</span>
                            </div>
                        </div>
                        <div class="review-body">
                            <p>${review.review_text}</p>
                        </div>
                        <div class="review-footer">
                            <div class="d-flex justify-content-between">
                                <span>Posted: ${formatDate(review.created_at)}</span>
                                ${review.updated_at && review.updated_at !== review.created_at ? 
                                `<span>Updated: ${formatDate(review.updated_at)}</span>` : ''}
                            </div>
                        </div>
                    `;
                    
                    reviewsContainer.appendChild(reviewCard);
                });
            } else {
                reviewsContainer.innerHTML = `
                    <div class="text-center p-5">
                        <i class="fas fa-search fa-3x mb-3 text-muted"></i>
                        <h4>No Reviews Found</h4>
                        <p class="text-muted">Be the first to review a Minecraft mod!</p>
                    </div>
                `;
            }
        } catch (error) {
            console.error('Error fetching reviews:', error);
            document.getElementById('reviews-container').innerHTML = `
                <div class="alert alert-danger" role="alert">
                    <i class="fas fa-exclamation-circle me-2"></i>
                    Error loading reviews: ${error.message}
                </div>
            `;
        }
    }
    
    // Filter reviews based on search and rating
    function filterReviews() {
        const searchTerm = document.getElementById('mod-search').value.toLowerCase();
        const minRating = parseInt(document.getElementById('rating-filter').value);
        
        const reviewCards = document.querySelectorAll('.review-card');
        
        reviewCards.forEach(card => {
            const modName = card.getAttribute('data-mod');
            const rating = parseInt(card.getAttribute('data-rating'));
            
            const matchesSearch = !searchTerm || modName.includes(searchTerm);
            const matchesRating = rating >= minRating;
            
            if (matchesSearch && matchesRating) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    }
    
    // Fetch reviews when the page loads
    document.addEventListener('DOMContentLoaded', fetchReviews);
</script>
{% endblock %}