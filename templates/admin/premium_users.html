{% extends 'base.html' %}

{% block content %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Premium User Management</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item"><a href="{{ url_for('index') }}">Dashboard</a></li>
        <li class="breadcrumb-item active">Premium Users</li>
    </ol>
    
    <div class="card mb-4">
        <div class="card-header">
            <i class="fas fa-star me-1"></i>
            Manage Premium Users
        </div>
        <div class="card-body">
            {% if not users %}
            <div class="alert alert-info">
                No users found in the system.
            </div>
            {% else %}
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="premiumUsersTable">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Email</th>
                            <th>Registered</th>
                            <th>Premium Status</th>
                            <th>Premium Since</th>
                            <th>Features</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in users %}
                        <tr>
                            <td>{{ user.username }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.created_at.strftime('%Y-%m-%d') }}</td>
                            <td>
                                <div class="form-check form-switch">
                                    <input class="form-check-input premium-toggle" type="checkbox" 
                                           id="premium-{{ user.id }}" 
                                           data-user-id="{{ user.id }}"
                                           {% if user.is_premium %}checked{% endif %}>
                                    <label class="form-check-label" for="premium-{{ user.id }}">
                                        {% if user.is_premium %}
                                        <span class="badge bg-success">Premium</span>
                                        {% else %}
                                        <span class="badge bg-secondary">Standard</span>
                                        {% endif %}
                                    </label>
                                </div>
                            </td>
                            <td>
                                {% if user.premium_since %}
                                {{ user.premium_since.strftime('%Y-%m-%d') }}
                                {% else %}
                                -
                                {% endif %}
                            </td>
                            <td>
                                {% if user.premium_features %}
                                <ul class="list-unstyled mb-0">
                                    {% for feature in user.premium_features %}
                                    <li>
                                        <span class="badge rounded-pill bg-primary">
                                            {{ feature.feature.name }}
                                            {% if feature.expires_at %}
                                            <small>(exp: {{ feature.expires_at.strftime('%Y-%m-%d') }})</small>
                                            {% endif %}
                                        </span>
                                    </li>
                                    {% endfor %}
                                </ul>
                                {% else %}
                                <span class="text-muted">No premium features</span>
                                {% endif %}
                            </td>
                            <td>
                                <button type="button" class="btn btn-sm btn-primary add-feature-btn" 
                                        data-bs-toggle="modal" 
                                        data-bs-target="#addFeatureModal" 
                                        data-user-id="{{ user.id }}" 
                                        data-username="{{ user.username }}">
                                    <i class="fas fa-plus"></i> Add Feature
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Add Feature Modal -->
<div class="modal fade" id="addFeatureModal" tabindex="-1" aria-labelledby="addFeatureModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addFeatureModalLabel">Add Premium Feature</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addFeatureForm">
                    <input type="hidden" id="userIdInput" name="user_id">
                    <div class="mb-3">
                        <label for="usernameDisplay" class="form-label">Username</label>
                        <input type="text" class="form-control" id="usernameDisplay" readonly>
                    </div>
                    <div class="mb-3">
                        <label for="featureSelect" class="form-label">Select Feature</label>
                        <select class="form-select" id="featureSelect" name="feature_id" required>
                            <option value="" disabled selected>Choose a premium feature</option>
                            {% for feature in features %}
                            <option value="{{ feature.id }}">{{ feature.name }} - {{ feature.description }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="expiresInput" class="form-label">Expires After (days)</label>
                        <input type="number" class="form-control" id="expiresInput" name="expires_days" 
                               placeholder="Leave empty for never" min="1">
                        <div class="form-text">Leave empty for permanent access to this feature</div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveFeatureButton">Add Feature</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle premium toggle switches
    const premiumToggles = document.querySelectorAll('.premium-toggle');
    premiumToggles.forEach(toggle => {
        toggle.addEventListener('change', function() {
            const userId = this.dataset.userId;
            const isPremium = this.checked;
            
            // Update the badge
            const label = this.nextElementSibling;
            const badge = label.querySelector('.badge');
            
            if (isPremium) {
                badge.className = 'badge bg-success';
                badge.textContent = 'Premium';
            } else {
                badge.className = 'badge bg-secondary';
                badge.textContent = 'Standard';
            }
            
            // Send API request to update premium status
            fetch('/api/admin/toggle-premium', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ user_id: userId })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Show success toast or alert
                    alert(data.message);
                    // Reload the page to refresh the data
                    location.reload();
                } else {
                    // Show error toast or alert
                    alert('Error: ' + data.message);
                    // Revert the toggle
                    this.checked = !isPremium;
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('An error occurred while updating premium status');
                // Revert the toggle
                this.checked = !isPremium;
            });
        });
    });
    
    // Handle Add Feature button click
    const addFeatureButtons = document.querySelectorAll('.add-feature-btn');
    addFeatureButtons.forEach(button => {
        button.addEventListener('click', function() {
            const userId = this.dataset.userId;
            const username = this.dataset.username;
            
            // Populate the modal with user data
            document.getElementById('userIdInput').value = userId;
            document.getElementById('usernameDisplay').value = username;
        });
    });
    
    // Handle Save Feature button click
    document.getElementById('saveFeatureButton').addEventListener('click', function() {
        const form = document.getElementById('addFeatureForm');
        const formData = new FormData(form);
        const userId = formData.get('user_id');
        const featureId = formData.get('feature_id');
        const expiresDays = formData.get('expires_days') || null;
        
        // Validate form data
        if (!featureId) {
            alert('Please select a feature');
            return;
        }
        
        // Send API request to assign feature
        fetch('/api/admin/assign-feature', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: userId,
                feature_id: featureId,
                expires_days: expiresDays
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                // Close the modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addFeatureModal'));
                modal.hide();
                
                // Show success toast or alert
                alert(data.message);
                
                // Reload the page to refresh the data
                location.reload();
            } else {
                // Show error toast or alert
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while assigning the feature');
        });
    });
    
    // Initialize DataTable if available
    if (typeof $.fn.DataTable !== 'undefined') {
        $('#premiumUsersTable').DataTable({
            responsive: true,
            order: [[3, 'desc']]  // Sort by premium status
        });
    }
});
</script>
{% endblock %}